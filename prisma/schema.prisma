// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String    @id @default(uuid())
  email      String    @unique
  name       String?
  role       UserRole  @default(STUDENT)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  purchases  Purchase[]
  grants     AccessGrant[]
  auditLogs  AuditLog[] @relation("actor")
}

model Question {
  id               String           @id @default(uuid())
  slug             String?          @unique
  discipline       String?
  difficulty       Difficulty?      @default(MEDIUM)
  activeVersionId  String?
  createdById      String?
  createdBy        User?            @relation(fields: [createdById], references: [id])
  createdAt        DateTime         @default(now())
  versions         QuestionVersion[]
  isArchived       Boolean          @default(false)
}

model QuestionVersion {
  id            String   @id @default(uuid())
  questionId    String
  question      Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  versionNumber Int
  title         String?
  contentJson   Json
  optionsJson   Json?
  explanation   String?
  createdById   String?
  createdBy     User?    @relation(fields: [createdById], references: [id])
  createdAt     DateTime @default(now())
  isPublished   Boolean  @default(false)
  publishedAt   DateTime?
}

model Media {
  id          String   @id @default(uuid())
  url         String
  filename    String?
  contentType String?
  ownerId     String?
  owner       User?    @relation(fields: [ownerId], references: [id])
  createdAt   DateTime @default(now())
}

model Product {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  description String?
  priceCents  Int
  currency    String   @default("INR")
  type        ProductType @default(ONE_TIME)
  metadata    Json?
  createdAt   DateTime @default(now())
  purchases   Purchase[]
}

model Purchase {
  id             String   @id @default(uuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  productId      String
  product        Product  @relation(fields: [productId], references: [id])
  provider       String
  providerSessionId String?
  status         PurchaseStatus @default(PENDING)
  startedAt      DateTime @default(now())
  completedAt    DateTime?
  metadata       Json?
}

model AccessGrant {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  productId  String
  product    Product  @relation(fields: [productId], references: [id])
  active     Boolean  @default(true)
  expiresAt  DateTime?
  createdAt  DateTime @default(now())
}

model AuditLog {
  id          String   @id @default(uuid())
  actorId     String?
  actor       User?    @relation("actor", fields: [actorId], references: [id])
  actionType  String
  targetTable String?
  targetId    String?
  payload     Json?
  createdAt   DateTime @default(now())
}

enum UserRole {
  STUDENT
  ADMIN
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum ProductType {
  ONE_TIME
  SUBSCRIPTION
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}
